<!--D3 library-->
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  svg {
     cursor: pointer;
   }
</style>
<div class="container mx-auto">
  <h1>Statewide Project Portfolio and Project Outcomes</h1>
  <h2 class="h3 text-center">FY 22-23 Current Project Portfolio</h2>
  <div class="row">
    <div class="col-lg-6">
      <div id="chart"></div>
    </div>
    <div class="col-lg-6 d-flex flex-column">

      <div class="d-flex mt-auto cursor-pointer bg-gray-50-hover transform-scale-1_05--hover transition-0_3" role="button" onclick="setDdValue('Dept Delegation')">
        <div class="height-30 width-30 m-r-sm" style="background-color: #666666;"></div>
        <p> Dept Delegation</p>
      </div>
      <div class="d-flex cursor-pointer bg-gray-50-hover transform-scale-1_05--hover transition-0_3" role="button" onclick="setDdValue('CDT Oversight - Medium Risk')">
        <div class="height-30 width-30 m-r-sm" style="background-color: #1a3e62;"></div>
        <p> CDT Oversight - Medium Risk</p>
      </div>
      <div class="d-flex cursor-pointer bg-gray-50-hover transform-scale-1_05--hover transition-0_3" role="button" onclick="setDdValue('CDT Oversight - Low Risk')">
        <div class="height-30 width-30 m-r-sm" style="background-color: #4590ca;"></div>
        <p> CDT Oversight - Low Risk</p>
      </div>
      <div class="d-flex mb-auto cursor-pointer bg-gray-50-hover transform-scale-1_05--hover transition-0_3" role="button" onclick="setDdValue('CDT Oversight - High Risk')">
        <div class="height-30 width-30 m-r-sm" style="background-color: #f2b23e;"></div>
        <p class="colot-primary-hover"> CDT Oversight - High Risk</p>
      </div>
      
    </div>
  </div>
</div>



<script>
const setDdValue = (value) => {
   const ddRisk = document.getElementById("ddRisk");
   ddRisk.value = value;
   ddRisk.dispatchEvent(new Event("change"));
}

  const chartData = [
    {
        "Risk": "Dept Delegation",
        "Value": 194,
        "color": "#666666", // gray
        "hovercolor": "#595959"
    },
    {
        "Risk": "CDT Oversight - Medium Risk",
        "Value": 73,
        "color": "#1a3e62", // cdt blue
        "hovercolor": "#17385b"
    },
    {
        "Risk": "CDT Oversight - Low Risk",
        "Value": 45,
        "color": "#4590ca", // light blue
        "hovercolor": "#3786C3"
    },
    {
        "Risk": "CDT Oversight - High Risk",
        "Value": 16,
        "color": "#f2b23e", // yellow
        "hovercolor": "#C4840E"
    }
];

const width = 370;
const height = 370;
const radius = Math.min(width, height) / 2;

const svg = d3.select("#chart")
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", `translate(${width / 2}, ${height / 2})`);

const colorScale = d3.scaleOrdinal()
    .domain(chartData.map(d => d.Risk))
    .range(d3.schemeCategory10);

const pie = d3.pie()
    .value(d => d.Value);

const arc = d3.arc()
    .innerRadius(radius * 0.7) // Adjust inner radius for thinner slices
    .outerRadius(radius * .85);

const arcs = svg.selectAll("arc")
    .data(pie(chartData))
    .enter()
    .append("g")
    .attr("class", "arc")
     // Make slices focusable

arcs.append("path")
    .attr("d", arc)
    .attr("fill", d => d.data.color) // Use the specified color
    .attr("tabindex", "0")
    
    // update table when clicking on donut sections
    .on("click", (event, d) => setDdValue(d.data.Risk))

    .on("mouseover focus", function (event, d) {
      d3.select(this).attr("fill", d.data.hovercolor);
        // Show tooltip with percentage
        const percentage = ((d.endAngle - d.startAngle) / (2 * Math.PI)) * 100;
        const tooltipLine1 = `${d.data.Risk}`; // New line for percentage
        const tooltipLine2 = `${percentage.toFixed(2)}%`; // New line for percentage
        d3.select("#tooltip")
            .text(tooltipLine1)
            .style("visibility", "visible")
            .style("font-size", ".85em");
        d3.select("#percent")
            .text(tooltipLine2)
            .style("visibility", "visible")
            .style("font-size", "2em")
            .style("fill", d.data.hovercolor);
        d3.select("#totalValueText").style("visibility", "hidden");
        d3.select("#totalValue").style("visibility", "hidden");
    })

    .on("mouseout blur", function () {
      d3.select(this).attr("fill", d => d.data.color);
        // Hide tooltip
        d3.select("#tooltip").style("visibility", "hidden");
        d3.select("#percent").style("visibility", "hidden");
        d3.select("#totalValueText").style("visibility", "visible");
        d3.select("#totalValue").style("visibility", "visible");
    });



// Calculate the total value
const totalValue = chartData.reduce((sum, d) => sum + d.Value, 0);

// Add text for the total projects value text inside of the donut
svg.append("text")
    .attr("id", "totalValueText")
    .attr("text-anchor", "middle")
    .attr("dy", "-1.5em")
    .style("font-size", ".85em")
    .text(`Total projects`);

svg.append("text")
    .attr("id", "totalValue")
    .attr("text-anchor", "middle")
    .attr("dy", "0.5em") // Adjust vertical position for percentage
    .style("font-size", "2em") // Adjust font size for total value
    .text(`${totalValue}`);

// Add labels outside of the donut
const labelArc = d3.arc()
    .innerRadius(radius * .8) // Adjust inner radius for label position
    .outerRadius(radius * 1.1);

// Labels next to the slices
arcs.append("text")
    .attr("transform", d => `translate(${labelArc.centroid(d)})`)
    .attr("dy", "0.35em")
    .attr("text-anchor", "middle")
    .style("font-size", "1rem") // Adjust font size for labels
    .text(d => d.data.Value);

// Add tooltips
svg.append("text")
    .attr("id", "tooltip")
    .attr("text-anchor", "middle")
    .attr("dy", "-1.5em") // Adjust vertical position for tooltip
    .style("visibility", "hidden");

svg.append("text")
    .attr("id", "percent")
    .attr("text-anchor", "middle")
    .attr("dy", "0.5em") // Adjust vertical position for percentage
    .style("visibility", "hidden");
</script>
